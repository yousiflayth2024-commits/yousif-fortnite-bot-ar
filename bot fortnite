import os
import sqlite3
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, CallbackQueryHandler, filters
import datetime

DB_PATH = os.getenv('DB_PATH', 'bot_data.db')

def init_db():
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY,
        username TEXT,
        first_name TEXT
    )""")
    conn.commit()
    conn.close()

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute('REPLACE INTO users (id, username, first_name) VALUES (?, ?, ?)',
                (user.id, user.username or '', user.first_name or ''))
    conn.commit()
    conn.close()
    kb = InlineKeyboardMarkup([
        [InlineKeyboardButton('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø´ÙˆØ¨', callback_data='shop')],
        [InlineKeyboardButton('Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±', callback_data='news')],
        [InlineKeyboardButton('Ù…Ø³Ø§Ø¹Ø¯Ø©', callback_data='help')]
    ])
    name = user.first_name or 'Ù„Ø§Ø¹Ø¨'
    await update.message.reply_text(f'Ù‡Ù„Ø§ {name} ğŸ‘‹\nØ£Ù†Ø§ Ø¨ÙˆØª ÙÙˆØ±ØªÙ†Ø§ÙŠØª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ. Ø§Ø®ØªÙØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ùˆ Ø§ÙƒØªØ¨ Ø£Ù…Ø±. /help', reply_markup=kb)

async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    txt = (
        "Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ):\n"
        "/start - Ø¨Ø¯Ø§ÙŠØ©\n"
        "/help - Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆØ§Ù…Ø±\n"
        "/shop - Ø¹Ø±Ø¶ Ø¢ÙŠØªÙ… Ø´ÙˆØ¨ (Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©)\n"
        "/news - Ø¢Ø®Ø± Ø£Ø®Ø¨Ø§Ø± ÙÙˆØ±ØªÙ†Ø§ÙŠØª (ØªØ¬Ø±ÙŠØ¨ÙŠ)\n"
        "/weapon <Ø§Ø³Ù…> - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø³Ù„Ø§Ø­\n"
    )
    await update.message.reply_text(txt)

async def shop_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    items = ["1) Ø¨Ù†Ø¯Ù‚ÙŠØ© Ø§Ù„Ù‡Ø¬ÙˆÙ… Scar", "2) Ø¯Ø±Ø¹ Ø£Ø³Ø·ÙˆØ±ÙŠ", "3) Ø³ÙƒÙŠÙ† Ù†Ø§Ø¯Ø±Ø©", "4) Ø·Ø§Ø¦Ø±Ø© ÙˆØ±Ù‚ÙŠØ© Ø¬Ù„Ø¯ÙŠØ©"]
    txt = "Ø¢ÙŠØªÙ… Ø´ÙˆØ¨ Ø§Ù„ÙŠÙˆÙ…:\n" + "\n".join(items) + "\n\n(Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©)"
    await update.message.reply_text(txt)

async def news_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M')
    txt = f"Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± (ØªØ¬Ø±ÙŠØ¨ÙŠ) â€” {now}\n- ÙØµÙ„ Ø¬Ø¯ÙŠØ¯ Ù‚Ø§Ø¯Ù… Ù‚Ø±ÙŠØ¨Ø§Ù‹!\n- ÙØ¹Ø§Ù„ÙŠØ§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©."
    await update.message.reply_text(txt)

async def weapon_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    if not args:
        await update.message.reply_text("Ø§ÙƒØªØ¨: /weapon <Ø§Ø³Ù…_Ø§Ù„Ø³Ù„Ø§Ø­> (Ù…Ø«Ø§Ù„: /weapon scar)")
        return
    name = " ".join(args).lower()
    sample = {
        "scar": "Scar â€” Ø¨Ù†Ø¯Ù‚ÙŠØ© Ù‡Ø¬ÙˆÙ…ÙŠØ© Ù‚ÙˆÙŠØ©ØŒ Ø¯Ù‚Ø© Ù…Ù…ØªØ§Ø²Ø©ØŒ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…ØªÙˆØ³Ø·.",
        "pump": "Pump â€” Ø¨Ù†Ø¯Ù‚ÙŠØ© Ø´ÙˆØªØ¬Ø§Ù†ØŒ Ø¶Ø±Ø± Ø¹Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù‚Ø±ÙŠØ¨.",
        "rpg": "RPG â€” Ù‚Ø§Ø°Ù ØµÙˆØ§Ø±ÙŠØ®ØŒ ÙŠØ³Ø¨Ø¨ Ø§Ù†ÙØ¬Ø§Ø± Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© ÙƒØ¨ÙŠØ±Ø©."
    }
    info = sample.get(name, "Ù…Ø¹Ø°Ø±Ø©ØŒ Ù…Ø§ Ø¹Ù†Ø¯ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø³Ù„Ø§Ø­ Ø§Ù„Ø¢Ù†.")
    await update.message.reply_text(info)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    if data == 'shop':
        await query.edit_message_text("Ø¢ÙŠØªÙ… Ø´ÙˆØ¨ Ø§Ù„ÙŠÙˆÙ…:\n- Ø¨Ù†Ø¯Ù‚ÙŠØ© Scar\n- Ø¯Ø±Ø¹ Ø£Ø³Ø·ÙˆØ±ÙŠ\n(Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©)")
    elif data == 'news':
        await query.edit_message_text("Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±: ÙØµÙ„ Ø¬Ø¯ÙŠØ¯ Ù‚Ø§Ø¯Ù…! (Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©)")
    elif data == 'help':
        await query.edit_message_text("Ø§Ø³ØªØ®Ø¯Ù… /help Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø£Ùˆ Ø±Ø§Ø³Ù„ Ø§Ù„Ù…Ø·ÙˆØ±.")

async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    txt = update.message.text.lower()
    if 'Ø´ÙˆØ¨' in txt or 'shop' in txt:
        await shop_cmd(update, context)
    elif 'Ø®Ø¨Ø±' in txt or 'Ø§Ø®Ø¨Ø§Ø±' in txt:
        await news_cmd(update, context)
    else:
        await update.message.reply_text("Ù…Ø§ ÙÙ‡Ù…ØªØŒ Ø§ÙƒØªØ¨ /help Ù„Ù„Ø£ÙˆØ§Ù…Ø± Ø£Ùˆ Ø§Ø¶ØºØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø±.")

def main():
    BOT_TOKEN = os.getenv('BOT_TOKEN', 'PUT_YOUR_TOKEN_HERE')
    if BOT_TOKEN == :7588131232:AAFiouxXzq2r9N1WGUj2dsqQtEhj2k73opA
        print("Ø¶Ø¹ Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© BOT_TOKEN ÙÙŠ Railway Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø©.")
    init_db()
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler('start', start))
    app.add_handler(CommandHandler('help', help_cmd))
    app.add_handler(CommandHandler('shop', shop_cmd))
    app.add_handler(CommandHandler('news', news_cmd))
    app.add_handler(CommandHandler('weapon', weapon_cmd))
    app.add_handler(CallbackQueryHandler(button_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))
    print("Bot is running...")
    app.run_polling()

if __name__ == '__main__':
    main()
